<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Management | QMS</title>
<meta name="description" content="Quality Management System - Event Management">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a733e',
              'primary-dark': '#0d5e3a',
              'dark-forest': '#032816',
              'success': '#10b981',
              'warning': '#f59e0b',
              'error': '#ef4444',
            },
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-check.js"></script>
    <script src="confirmation-dialog.js"></script>
    <script src="load-sidebar.js"></script>
    <script src="dark-mode.js"></script>
    <script src="search.js"></script>
    <script src="form-validation.js"></script>
    <script src="keyboard-shortcuts.js"></script>
    <script src="timezone-utils.js"></script>
    <script src="date-filter-utils.js"></script>
<style>
  .main-content {
    background-color: #f8f7f2;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }

  /* Dark Mode Styles */
  [data-theme="dark"] .main-content {
    background-color: var(--background-color);
  }

  [data-theme="dark"] .bg-white {
    background-color: var(--background-white) !important;
  }

  [data-theme="dark"] .border-gray-200 {
    border-color: var(--border-light) !important;
  }

  [data-theme="dark"] .text-gray-900 {
    color: var(--text-color) !important;
  }

  [data-theme="dark"] .text-gray-600 {
    color: var(--text-secondary) !important;
  }

  [data-theme="dark"] .text-gray-500 {
    color: var(--text-muted) !important;
  }

  [data-theme="dark"] .hover\:bg-gray-50:hover {
    background-color: var(--gray-100) !important;
  }
</style>
</head>

<body>
<!-- Sidebar will be loaded dynamically by load-sidebar.js -->
 <main class="main-content" role="main">
    <div class="px-4 py-4 max-w-7xl mx-auto w-full">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-xl font-bold text-gray-900">Event Management</h1>
          <p id="eventScopeInfo" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <button id="createEventBtn" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded hover:bg-primary-dark transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create Event
        </button>
      </div>

      <!-- Event Types Filter -->
      <div class="mb-4 flex items-center gap-2 flex-wrap">
        <button class="event-type-filter active px-3 py-1.5 bg-primary text-white text-xs font-semibold rounded hover:bg-primary-dark transition-colors" data-type="all">
          All Events
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="session">
          Sessions
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="meeting">
          Meetings
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="feedback">
          Feedback Sessions
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="training">
          Training
        </button>
      </div>

      <!-- Events List -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div id="eventsList" class="divide-y divide-gray-200">
          <!-- Empty State -->
          <div class="px-4 py-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-sm font-semibold text-gray-700 mb-1">No events scheduled</p>
            <p class="text-xs text-gray-500 mb-4">Create your first event to get started</p>
            <button onclick="document.getElementById('createEventBtn').click()" class="px-4 py-2 bg-primary text-white text-xs font-semibold rounded hover:bg-primary-dark transition-colors">
              Create Event
            </button>
          </div>
        </div>
      </div>
    </div>
</main>

<!-- Create/Edit Event Modal -->
<div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
      <h2 id="eventModalTitle" class="text-lg font-semibold text-gray-900">Create Event</h2>
      <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <form id="eventForm" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Event Title *</label>
        <input type="text" id="eventTitle" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter event title">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Event Type *</label>
          <select id="eventType" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Select type</option>
            <option value="session">Session</option>
            <option value="meeting">Meeting</option>
            <option value="feedback">Feedback Session</option>
            <option value="training">Training</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Date *</label>
          <input type="date" id="eventDate" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Start Time *</label>
          <input type="time" id="eventStartTime" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">End Time *</label>
          <input type="time" id="eventEndTime" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
        <textarea id="eventDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter event description"></textarea>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Participants</label>
        <div class="relative">
          <input type="text" id="participantSearch" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Type to search participants by name or email..." autocomplete="off">
          <div id="participantDropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            <!-- Autocomplete results will appear here -->
          </div>
          <div id="selectedParticipants" class="flex flex-wrap gap-2 mt-2 min-h-[2.5rem] p-2 border border-gray-300 rounded bg-white">
            <!-- Selected participants will appear here as tags -->
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-1">Type a few letters to search and select participants</p>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Google Meet Link</label>
        <div class="flex gap-2">
          <input type="text" id="eventMeetLink" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="https://meet.google.com/xxx-xxxx-xxx or Meet ID">
          <button type="button" onclick="pasteMeetLink()" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-200 transition-colors flex items-center gap-1" title="Paste from clipboard">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Paste
          </button>
          <button type="button" onclick="createMeetLink()" class="px-3 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors flex items-center gap-1" title="Create new Google Meet link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Create
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Enter full Google Meet URL or just the Meet ID (e.g., abc-defg-hij), or use the buttons above</p>
      </div>

      <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
        <button type="submit" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded hover:bg-primary-dark transition-colors">
          Save Event
        </button>
        <button type="button" onclick="closeEventModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-50 transition-colors">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- View Event Modal -->
<div id="viewEventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
      <h2 class="text-lg font-semibold text-gray-900">Event Details</h2>
      <button onclick="closeViewEventModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div id="viewEventContent" class="p-6 space-y-4">
      <!-- Content will be populated by JavaScript -->
    </div>
    
    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-end gap-3">
      <button onclick="closeViewEventModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-50 transition-colors">
        Close
      </button>
    </div>
  </div>
</div>

<script>
// Event Management State
let events = [];
let currentFilter = 'all';
let editingEventId = null;
let allUsers = []; // Store all users for autocomplete
let selectedParticipants = []; // Store selected participant objects

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
  await initializeEventManagement();
});

async function initializeEventManagement() {
  setupEventListeners();
  await loadUsers();
  updateEventScopeInfo();
  await loadEvents();
  setupParticipantAutocomplete();
  renderEvents();
}

function updateEventScopeInfo() {
  const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
  const isSuperAdmin = userInfo.role === 'Super Admin';
  const scopeInfo = document.getElementById('eventScopeInfo');
  
  if (scopeInfo) {
    if (isSuperAdmin) {
      scopeInfo.textContent = 'Viewing all events (Super Admin)';
      scopeInfo.classList.remove('text-gray-500');
      scopeInfo.classList.add('text-blue-600', 'font-medium');
    } else {
      scopeInfo.textContent = 'Viewing your events only';
      scopeInfo.classList.remove('text-blue-600', 'font-medium');
      scopeInfo.classList.add('text-gray-500');
    }
  }
}

function setupEventListeners() {
  // Create event button
  const createEventBtn = document.getElementById('createEventBtn');
  if (createEventBtn) {
    createEventBtn.addEventListener('click', () => openEventModal());
  }

  // Event type filters
  const filterButtons = document.querySelectorAll('.event-type-filter');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      filterButtons.forEach(b => {
        b.classList.remove('active', 'bg-primary', 'text-white');
        b.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200');
      });
      btn.classList.add('active', 'bg-primary', 'text-white');
      btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200');
      
      // Update filter
      currentFilter = btn.dataset.type;
      renderEvents();
    });
  });

  // Event form submission
  const eventForm = document.getElementById('eventForm');
  if (eventForm) {
    eventForm.addEventListener('submit', handleEventSubmit);
  }
}

async function loadUsers() {
  try {
    if (!window.supabaseClient) {
      console.error('Supabase client not initialized');
      return;
    }

    const { data, error } = await window.supabaseClient
      .from('users')
      .select('email, name, role, department')
      .eq('is_active', true)
      .order('name', { ascending: true });

    if (error) {
      console.error('Error loading users:', error);
      return;
    }

    allUsers = data || [];
  } catch (error) {
    console.error('Error loading users:', error);
    allUsers = [];
  }
}

function setupParticipantAutocomplete() {
  const searchInput = document.getElementById('participantSearch');
  const dropdown = document.getElementById('participantDropdown');
  const selectedContainer = document.getElementById('selectedParticipants');

  if (!searchInput || !dropdown || !selectedContainer) return;

  // Handle input typing
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    
    if (query.length === 0) {
      dropdown.classList.add('hidden');
      return;
    }

    // Filter users by name or email
    const filtered = allUsers.filter(user => {
      const name = (user.name || '').toLowerCase();
      const email = (user.email || '').toLowerCase();
      return name.includes(query) || email.includes(query);
    }).filter(user => {
      // Exclude already selected participants
      return !selectedParticipants.some(selected => selected.email === user.email);
    });

    if (filtered.length === 0) {
      dropdown.classList.add('hidden');
      return;
    }

    // Show dropdown with results
    dropdown.innerHTML = filtered.map((user, index) => `
      <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 participant-option" data-user-index="${index}">
        <div class="font-medium text-sm text-gray-900">${escapeHtml(user.name || user.email)}</div>
        <div class="text-xs text-gray-500">${escapeHtml(user.email)}</div>
        ${user.role ? `<div class="text-xs text-gray-400">${escapeHtml(user.role)}${user.department ? ` â€¢ ${escapeHtml(user.department)}` : ''}</div>` : ''}
      </div>
    `).join('');

    // Store filtered users temporarily for selection
    dropdown._filteredUsers = filtered;

    // Add click handlers to each option
    dropdown.querySelectorAll('.participant-option').forEach((option, index) => {
      option.addEventListener('click', () => {
        selectParticipant(filtered[index]);
      });
    });

    dropdown.classList.remove('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });

  // Handle keyboard navigation
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      dropdown.classList.add('hidden');
      searchInput.blur();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      const firstResult = dropdown.querySelector('div[onclick]');
      if (firstResult) {
        firstResult.click();
      }
    }
  });
}

window.selectParticipant = function(user) {
  // Check if already selected
  if (selectedParticipants.some(p => p.email === user.email)) {
    return;
  }

  selectedParticipants.push(user);
  renderSelectedParticipants();
  
  // Clear search input and hide dropdown
  document.getElementById('participantSearch').value = '';
  document.getElementById('participantDropdown').classList.add('hidden');
}

window.removeParticipant = function(email) {
  selectedParticipants = selectedParticipants.filter(p => p.email !== email);
  renderSelectedParticipants();
}

window.pasteMeetLink = async function() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      const meetLinkInput = document.getElementById('eventMeetLink');
      if (meetLinkInput) {
        // If it's already a full URL, use it as is
        // If it's just a meet code, convert to full URL
        let meetLink = text.trim();
        if (meetLink && !meetLink.startsWith('http://') && !meetLink.startsWith('https://')) {
          // Assume it's a meet code, convert to full URL
          const meetId = meetLink.replace(/[^a-z0-9-]/gi, '');
          if (meetId) {
            meetLink = `https://meet.google.com/${meetId}`;
          }
        }
        meetLinkInput.value = meetLink;
        
        // Show success feedback
        const button = document.querySelector('button[onclick="pasteMeetLink()"]');
        if (button) {
          const originalHTML = button.innerHTML;
          button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Pasted';
          button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
          button.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            button.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
          }, 1500);
        }
      }
    }
  } catch (error) {
    console.error('Error pasting from clipboard:', error);
    alert('Unable to paste from clipboard. Please make sure you have clipboard access permissions.');
  }
}

window.createMeetLink = function() {
  // Open Google Meet in a new tab so user can create a meeting
  window.open('https://meet.google.com', '_blank');
  
  // Show a helpful message
  const button = document.querySelector('button[onclick="createMeetLink()"]');
  if (button) {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg> Opened';
    button.classList.add('bg-green-600', 'hover:bg-green-700');
    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('bg-green-600', 'hover:bg-green-700');
      button.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }, 2000);
  }
}

function renderSelectedParticipants() {
  const container = document.getElementById('selectedParticipants');
  if (!container) return;

  if (selectedParticipants.length === 0) {
    container.innerHTML = '<span class="text-xs text-gray-400 italic">No participants selected</span>';
    return;
  }

  container.innerHTML = selectedParticipants.map(user => `
    <span class="inline-flex items-center gap-1 px-2 py-1 bg-primary text-white text-xs font-medium rounded">
      ${escapeHtml(user.name || user.email)}
      <button type="button" onclick="removeParticipant('${escapeHtml(user.email)}')" class="hover:bg-primary-dark rounded p-0.5 transition-colors">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </span>
  `).join('');
}

function openEventModal(event = null) {
  const modal = document.getElementById('eventModal');
  const modalTitle = document.getElementById('eventModalTitle');
  const form = document.getElementById('eventForm');
  
  if (!modal || !form) return;
  
  editingEventId = event ? event.id : null;
  
  if (event) {
    modalTitle.textContent = 'Edit Event';
    document.getElementById('eventTitle').value = event.title || '';
    document.getElementById('eventType').value = event.type || '';
    document.getElementById('eventDate').value = event.date || '';
    document.getElementById('eventStartTime').value = event.start_time || '';
    document.getElementById('eventEndTime').value = event.end_time || '';
    document.getElementById('eventDescription').value = event.description || '';
    
    // Handle participants - load into selectedParticipants array
    selectedParticipants = [];
    if (event.participants) {
      let participantEmails = [];
      if (Array.isArray(event.participants)) {
        participantEmails = event.participants;
      } else if (typeof event.participants === 'string') {
        try {
          const parsed = JSON.parse(event.participants);
          participantEmails = Array.isArray(parsed) ? parsed : [event.participants];
        } catch {
          participantEmails = event.participants.split(',').map(e => e.trim()).filter(e => e);
        }
      }
      
      // Match emails with user objects
      selectedParticipants = participantEmails
        .map(email => allUsers.find(u => u.email === email))
        .filter(u => u !== undefined);
    }
    renderSelectedParticipants();
    document.getElementById('participantSearch').value = '';
    
    document.getElementById('eventMeetLink').value = event.meet_link || '';
  } else {
    modalTitle.textContent = 'Create Event';
    form.reset();
    selectedParticipants = [];
    renderSelectedParticipants();
  }
  
  modal.classList.remove('hidden');
}

function editEvent(eventId) {
  const event = events.find(e => e.id === eventId);
  if (!event) return;
  
  // Check if user can edit this event
  const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
  const isSuperAdmin = userInfo.role === 'Super Admin';
  const isOwner = event.created_by === userInfo.email;
  
  if (!isSuperAdmin && !isOwner) {
    alert('You can only edit events that you created.');
    return;
  }
  
  openEventModal(event);
}

function viewEvent(eventId) {
  const event = events.find(e => e.id === eventId);
  if (!event) return;
  
  const modal = document.getElementById('viewEventModal');
  const content = document.getElementById('viewEventContent');
  
  if (!modal || !content) return;
  
  const typeColors = {
    session: 'bg-blue-100 text-blue-800',
    meeting: 'bg-purple-100 text-purple-800',
    feedback: 'bg-green-100 text-green-800',
    training: 'bg-orange-100 text-orange-800'
  };
  
  const typeLabels = {
    session: 'Session',
    meeting: 'Meeting',
    feedback: 'Feedback Session',
    training: 'Training'
  };
  
  // Parse participants
  let participants = [];
  if (event.participants) {
    if (Array.isArray(event.participants)) {
      participants = event.participants;
    } else if (typeof event.participants === 'string') {
      try {
        const parsed = JSON.parse(event.participants);
        participants = Array.isArray(parsed) ? parsed : [];
      } catch {
        participants = event.participants.split(',').map(p => p.trim()).filter(p => p);
      }
    }
  }
  
  content.innerHTML = `
    <div>
      <label class="block text-xs font-semibold text-gray-500 mb-1">Event Title</label>
      <div class="flex items-center gap-2 mb-4">
        <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(event.title)}</h3>
        <span class="px-2 py-1 rounded text-xs font-semibold ${typeColors[event.type] || 'bg-gray-100 text-gray-800'}">
          ${typeLabels[event.type] || event.type}
        </span>
      </div>
    </div>
    
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Date</label>
        <p class="text-sm text-gray-900">${formatDate(event.date)}</p>
      </div>
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Time</label>
        <p class="text-sm text-gray-900">${event.start_time || 'N/A'} - ${event.end_time || 'N/A'}</p>
      </div>
    </div>
    
    ${event.description ? `
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Description</label>
        <p class="text-sm text-gray-900 whitespace-pre-wrap">${escapeHtml(event.description)}</p>
      </div>
    ` : ''}
    
    ${participants.length > 0 ? `
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Participants</label>
        <div class="flex flex-wrap gap-2">
          ${participants.map(email => `
            <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${escapeHtml(email)}</span>
          `).join('')}
        </div>
      </div>
    ` : ''}
    
    ${event.meet_link ? `
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Google Meet Link</label>
        <a href="${escapeHtml(event.meet_link)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Join Google Meet
        </a>
        <p class="text-xs text-gray-500 mt-1 break-all">${escapeHtml(event.meet_link)}</p>
      </div>
    ` : ''}
    
    <div class="pt-4 border-t border-gray-200">
      <label class="block text-xs font-semibold text-gray-500 mb-1">Created By</label>
      <p class="text-sm text-gray-900">${escapeHtml(event.created_by || 'N/A')}</p>
      ${event.created_at ? `
        <p class="text-xs text-gray-500 mt-1">Created on ${formatDateTime(event.created_at)}</p>
      ` : ''}
    </div>
  `;
  
  modal.classList.remove('hidden');
}

function closeViewEventModal() {
  const modal = document.getElementById('viewEventModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function closeEventModal() {
  const modal = document.getElementById('eventModal');
  if (modal) {
    modal.classList.add('hidden');
    editingEventId = null;
    document.getElementById('eventForm').reset();
    selectedParticipants = [];
    renderSelectedParticipants();
    document.getElementById('participantSearch').value = '';
    document.getElementById('participantDropdown').classList.add('hidden');
  }
}

async function handleEventSubmit(e) {
  e.preventDefault();
  
  try {
    // Get current user from localStorage (same pattern as other pages)
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    if (!userInfo || !userInfo.email) {
      alert('You must be logged in to create events');
      return;
    }

    const title = document.getElementById('eventTitle').value.trim();
    const type = document.getElementById('eventType').value;
    const date = document.getElementById('eventDate').value;
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const description = document.getElementById('eventDescription').value.trim();
    const meetLinkInput = document.getElementById('eventMeetLink').value.trim();
    
    // Validate required fields
    if (!title || !type || !date || !startTime || !endTime) {
      alert('Please fill in all required fields');
      return;
    }

    // Validate time
    if (startTime >= endTime) {
      alert('End time must be after start time');
      return;
    }

    // Get participants from selectedParticipants array
    const participants = selectedParticipants.map(p => p.email);

    // Process meet link - convert Meet ID to full URL if needed
    let meetLink = null;
    if (meetLinkInput) {
      if (meetLinkInput.startsWith('http://') || meetLinkInput.startsWith('https://')) {
        meetLink = meetLinkInput;
      } else {
        // Assume it's a Meet ID, convert to full URL
        const meetId = meetLinkInput.replace(/[^a-z0-9-]/gi, ''); // Clean the ID
        if (meetId) {
          meetLink = `https://meet.google.com/${meetId}`;
        }
      }
    }

    const eventData = {
      title,
      type,
      date,
      start_time: startTime,
      end_time: endTime,
      description: description || null,
      participants: participants.length > 0 ? participants : null,
      meet_link: meetLink,
      created_by: userInfo.email
    };
    
    if (editingEventId) {
      await updateEvent(editingEventId, eventData);
    } else {
      await createEvent(eventData);
    }
    
    await loadEvents();
  closeEventModal();
  renderEvents();
  } catch (error) {
    console.error('Error saving event:', error);
    alert('Error saving event: ' + (error.message || 'Unknown error'));
  }
}

function renderEvents() {
  const eventsList = document.getElementById('eventsList');
  if (!eventsList) return;
  
  // Filter events
  let filteredEvents = events;
  if (currentFilter !== 'all') {
    filteredEvents = events.filter(event => event.type === currentFilter);
  }
  
  // Sort events by date and time (upcoming first)
  filteredEvents.sort((a, b) => {
    const dateA = new Date(`${a.date}T${a.start_time || '00:00'}`);
    const dateB = new Date(`${b.date}T${b.start_time || '00:00'}`);
    return dateA - dateB;
  });
  
  if (filteredEvents.length === 0) {
    eventsList.innerHTML = `
      <div class="px-4 py-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="text-sm font-semibold text-gray-700 mb-1">No ${currentFilter === 'all' ? '' : currentFilter} events scheduled</p>
        <p class="text-xs text-gray-500 mb-4">Create your first event to get started</p>
        <button onclick="document.getElementById('createEventBtn').click()" class="px-4 py-2 bg-primary text-white text-xs font-semibold rounded hover:bg-primary-dark transition-colors">
          Create Event
        </button>
      </div>
    `;
    return;
  }
  
  eventsList.innerHTML = filteredEvents.map(event => {
    const typeColors = {
      session: 'bg-blue-100 text-blue-800',
      meeting: 'bg-purple-100 text-purple-800',
      feedback: 'bg-green-100 text-green-800',
      training: 'bg-orange-100 text-orange-800'
    };
    
    const typeLabels = {
      session: 'Session',
      meeting: 'Meeting',
      feedback: 'Feedback Session',
      training: 'Training'
    };

    // Parse participants - handle both array and string formats
    let participants = [];
    if (event.participants) {
      if (Array.isArray(event.participants)) {
        participants = event.participants;
      } else if (typeof event.participants === 'string') {
        try {
          const parsed = JSON.parse(event.participants);
          participants = Array.isArray(parsed) ? parsed : [];
        } catch {
          // If parsing fails, treat as comma-separated string
          participants = event.participants.split(',').map(p => p.trim()).filter(p => p);
        }
      }
    }
    const participantCount = participants.length;
    
    return `
      <div class="px-4 py-4 hover:bg-gray-50 transition-colors cursor-pointer" onclick="viewEvent('${event.id}')">
        <div class="flex items-center justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-sm font-semibold text-gray-900">${escapeHtml(event.title)}</h3>
              <span class="px-2 py-0.5 rounded text-[10px] font-semibold ${typeColors[event.type] || 'bg-gray-100 text-gray-800'}">
                ${typeLabels[event.type] || event.type}
              </span>
            </div>
            <p class="text-xs text-gray-600 mb-2">${escapeHtml(event.description || 'No description')}</p>
            <div class="flex items-center gap-4 text-xs text-gray-500 flex-wrap">
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                ${formatDate(event.date)}
              </span>
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${event.start_time || 'N/A'} - ${event.end_time || 'N/A'}
              </span>
              ${participantCount > 0 ? `
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                  ${participantCount} participant${participantCount !== 1 ? 's' : ''}
                </span>
              ` : ''}
            </div>
          </div>
          <div class="flex items-center gap-2" onclick="event.stopPropagation()">
            ${event.meet_link ? `
              <a href="${escapeHtml(event.meet_link)}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors flex items-center gap-2" title="Join Google Meet">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Join
              </a>
            ` : ''}
            <button onclick="editEvent('${event.id}')" class="p-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors" title="Edit">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button onclick="deleteEvent('${event.id}')" class="p-1.5 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors" title="Delete">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Database functions
async function loadEvents() {
  try {
    if (!window.supabaseClient) {
      console.error('Supabase client not initialized');
      return;
    }

    // Get current user info to check role
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const currentUserEmail = userInfo.email;
    const isSuperAdmin = userInfo.role === 'Super Admin';

    let query = window.supabaseClient
      .from('events')
      .select('*');

    // If user is not Super Admin, only show their own events
    if (!isSuperAdmin && currentUserEmail) {
      query = query.eq('created_by', currentUserEmail);
    }

    const { data, error } = await query
      .order('date', { ascending: true })
      .order('start_time', { ascending: true });

    if (error) {
      console.error('Error loading events:', error);
      // If table doesn't exist, events will remain empty
      if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
        console.warn('Events table does not exist. Please create it in Supabase.');
      }
      events = [];
      return;
    }

    events = data || [];
  } catch (error) {
    console.error('Error loading events:', error);
    events = [];
  }
}

async function createEvent(eventData) {
  try {
    if (!window.supabaseClient) {
      throw new Error('Supabase client not initialized');
    }

    const { data, error } = await window.supabaseClient
      .from('events')
      .insert([eventData])
      .select()
      .single();

    if (error) {
      // If table doesn't exist, provide helpful error
      if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
        throw new Error('Events table does not exist. Please create it in Supabase first.');
      }
      throw error;
    }

    return data;
  } catch (error) {
    console.error('Error creating event:', error);
    throw error;
  }
}

async function updateEvent(eventId, eventData) {
  try {
    if (!window.supabaseClient) {
      throw new Error('Supabase client not initialized');
    }

    const { data, error } = await window.supabaseClient
      .from('events')
      .update(eventData)
      .eq('id', eventId)
      .select()
      .single();

    if (error) {
      throw error;
    }

    return data;
  } catch (error) {
    console.error('Error updating event:', error);
    throw error;
  }
}

async function deleteEvent(eventId) {
  // Check if user can delete this event
  const event = events.find(e => e.id === eventId);
  if (event) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const isSuperAdmin = userInfo.role === 'Super Admin';
    const isOwner = event.created_by === userInfo.email;
    
    if (!isSuperAdmin && !isOwner) {
      alert('You can only delete events that you created.');
      return;
    }
  }

  if (!confirm('Are you sure you want to delete this event?')) {
    return;
  }

  try {
    if (!window.supabaseClient) {
      throw new Error('Supabase client not initialized');
    }

    const { error } = await window.supabaseClient
      .from('events')
      .delete()
      .eq('id', eventId);

    if (error) {
      throw error;
    }

    await loadEvents();
    renderEvents();
  } catch (error) {
    console.error('Error deleting event:', error);
    alert('Error deleting event: ' + (error.message || 'Unknown error'));
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  const eventModal = document.getElementById('eventModal');
  const viewModal = document.getElementById('viewEventModal');
  
  if (eventModal && e.target === eventModal) {
    closeEventModal();
  }
  
  if (viewModal && e.target === viewModal) {
    closeViewEventModal();
  }
});
</script>
</body>
</html>

