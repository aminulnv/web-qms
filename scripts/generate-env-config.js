/**
 * Generate env-config.js from environment variables
 * This script reads environment variables and creates a browser-compatible config file
 * NOTE: Only PUBLIC values are included - secrets (like INTERCOM_ACCESS_TOKEN) are excluded
 */

const fs = require('fs');
const path = require('path');

// Load environment variables
// In Vercel, process.env is available; locally, we load from .env file
try {
  const envFile = fs.readFileSync(path.join(__dirname, '..', '.env'), 'utf8');
  envFile.split('\n').forEach(line => {
    const trimmedLine = line.trim();
    // Skip comments and empty lines
    if (!trimmedLine || trimmedLine.startsWith('#')) return;
    
    const [key, ...valueParts] = trimmedLine.split('=');
    if (key && valueParts.length > 0) {
      const value = valueParts.join('=').trim();
      // Remove quotes if present
      const cleanValue = value.replace(/^["']|["']$/g, '');
      // Only set if not already in process.env (environment variables take precedence)
      if (!process.env[key.trim()]) {
        process.env[key.trim()] = cleanValue;
      }
    }
  });
} catch (error) {
  // .env file not found - this is okay if environment variables are set in system/Vercel
  if (process.env.NODE_ENV !== 'production') {
    console.warn('Warning: .env file not found. Make sure environment variables are set.');
  }
}

// Read environment variables (only PUBLIC values - no secrets)
const envConfig = {
  SUPABASE_URL: process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL || '',
  SUPABASE_ANON_KEY: process.env.VITE_SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY || '',
  // INTERCOM_ACCESS_TOKEN is NOT included - it should only be used server-side
  INTERCOM_API_BASE_URL: process.env.INTERCOM_API_BASE_URL || 'https://api.intercom.io',
  INTERCOM_APP_ID: process.env.VITE_INTERCOM_APP_ID || process.env.INTERCOM_APP_ID || ''
};

// Generate the env-config.js file content
// NOTE: Only public values are included. Secrets must be used server-side only.
const configContent = `/**
 * Environment Configuration
 * This file is auto-generated from environment variables
 * DO NOT EDIT THIS FILE MANUALLY
 * 
 * NOTE: This file only contains PUBLIC values safe to expose in the browser.
 * Secrets (like INTERCOM_ACCESS_TOKEN) are NOT included and must be used server-side only.
 */

window.env = {
  SUPABASE_URL: '${envConfig.SUPABASE_URL}',
  SUPABASE_ANON_KEY: '${envConfig.SUPABASE_ANON_KEY}',
  INTERCOM_API_BASE_URL: '${envConfig.INTERCOM_API_BASE_URL}',
  INTERCOM_APP_ID: '${envConfig.INTERCOM_APP_ID}'
};
`;

// Write to env-config.js in the root directory
const outputPath = path.join(__dirname, '..', 'env-config.js');
fs.writeFileSync(outputPath, configContent, 'utf8');

console.log('✓ Generated env-config.js from environment variables');

// Validate that required variables are set
const requiredVars = ['SUPABASE_URL', 'SUPABASE_ANON_KEY'];
const missingVars = requiredVars.filter(varName => !envConfig[varName]);

if (missingVars.length > 0) {
  console.warn(`⚠ Warning: Missing required environment variables: ${missingVars.join(', ')}`);
  console.warn('  Make sure to set these in your .env file or Vercel environment variables');
} else {
  console.log('  - All required environment variables are set');
}