/**
 * Generate env-config.js from environment variables
 * This script reads environment variables and creates a browser-compatible config file
 */

const fs = require('fs');
const path = require('path');
require('dotenv').config();

// Read package.json to get version
const packageJsonPath = path.join(__dirname, '..', 'package.json');
const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
const APP_VERSION = packageJson.version || '1.0.0';

// Read environment variables
const envConfig = {
  SUPABASE_URL: process.env.SUPABASE_URL || '',
  SUPABASE_ANON_KEY: process.env.SUPABASE_ANON_KEY || '',
  INTERCOM_ACCESS_TOKEN: process.env.INTERCOM_ACCESS_TOKEN || '',
  INTERCOM_API_BASE_URL: process.env.INTERCOM_API_BASE_URL || 'https://api.intercom.io',
  INTERCOM_APP_ID: process.env.INTERCOM_APP_ID || ''
};

// Generate the env-config.js file content
const configContent = `/**
 * Environment Configuration
 * This file is auto-generated from environment variables
 * DO NOT EDIT THIS FILE MANUALLY
 */

window.env = {
  SUPABASE_URL: '${envConfig.SUPABASE_URL}',
  SUPABASE_ANON_KEY: '${envConfig.SUPABASE_ANON_KEY}',
  INTERCOM_ACCESS_TOKEN: '${envConfig.INTERCOM_ACCESS_TOKEN}',
  INTERCOM_API_BASE_URL: '${envConfig.INTERCOM_API_BASE_URL}',
  INTERCOM_APP_ID: '${envConfig.INTERCOM_APP_ID}'
};
`;

// Generate version.js file content
const versionContent = `/**
 * Application Version
 * This file is auto-generated from package.json
 * DO NOT EDIT THIS FILE MANUALLY
 */

window.APP_VERSION = '${APP_VERSION}';
`;

// Write to env-config.js in the root directory
const outputPath = path.join(__dirname, '..', 'env-config.js');
fs.writeFileSync(outputPath, configContent, 'utf8');

// Write to version.js in the root directory
const versionPath = path.join(__dirname, '..', 'version.js');
fs.writeFileSync(versionPath, versionContent, 'utf8');

console.log('✓ Generated env-config.js from environment variables');
console.log(`✓ Generated version.js with version: ${APP_VERSION}`);

// Validate that required variables are set
const requiredVars = ['SUPABASE_URL', 'SUPABASE_ANON_KEY'];
const missingVars = requiredVars.filter(varName => !envConfig[varName]);

if (missingVars.length > 0) {
  console.warn(`⚠ Warning: Missing required environment variables: ${missingVars.join(', ')}`);
  console.warn('  Make sure to set these in your .env file or Vercel environment variables');
}

