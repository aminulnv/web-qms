-- Migration: Recreate ai_analysis_results table with same schema as fnchat_cfd_v2

-- Drop existing table and all its dependencies
DROP TABLE IF EXISTS ai_analysis_results CASCADE;

-- Create new table with exact same schema as fnchat_cfd_v2
CREATE TABLE ai_analysis_results (
    id TEXT NOT NULL,
    submitted_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    audit_start_time TIMESTAMPTZ,
    audit_end_time TIMESTAMPTZ,
    audit_duration INTEGER,
    auditor_email TEXT,
    auditor_name TEXT,
    employee_name TEXT,
    employee_email TEXT,
    employee_type TEXT,
    employee_department TEXT,
    interaction_id TEXT,
    interaction_date DATE,
    audit_type TEXT,
    channel TEXT,
    quarter TEXT,
    week INTEGER,
    country_of_employee TEXT,
    client_email TEXT,
    agent_pre_status TEXT,
    agent_post_status TEXT,
    passing_status TEXT,
    validation_status TEXT,
    average_score NUMERIC,
    critical_errors INTEGER DEFAULT 0,
    critical_fail_error INTEGER DEFAULT 0,
    significant_error INTEGER DEFAULT 0,
    total_errors_count INTEGER DEFAULT 0,
    transcript TEXT,
    error_description TEXT,
    recommendations TEXT,
    training_required TEXT,
    training_topics TEXT,
    reversal_requested_at TIMESTAMPTZ,
    reversal_responded_at TIMESTAMPTZ,
    sla_in_hours NUMERIC,
    reason_for_reversal_response_delay TEXT,
    reversal_approved TEXT,
    within_auditor_scope TEXT,
    score_before_appeal NUMERIC,
    score_after_appeal NUMERIC,
    did_result_in_pass TEXT,
    reversal_type TEXT,
    reversal_metrics_parameters TEXT,
    reversal_justification_from_agent TEXT,
    reversal_attachments TEXT,
    reversal_approved_by TEXT,
    reversal_resolved_by TEXT,
    acknowledgement_status TEXT DEFAULT 'Pending',
    acknowledgement_status_updated_at TIMESTAMPTZ,
    parameter_comments JSONB,
    created_by TEXT,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_by TEXT,
    updated_at TIMESTAMPTZ,
    version INTEGER DEFAULT 1,
    activity_log JSONB,
    error_loss_business INTEGER DEFAULT 0,
    feedback_error_loss_business TEXT,
    zero_tolerance INTEGER DEFAULT 0,
    feedback_zero_tolerance TEXT,
    incorrect_information INTEGER DEFAULT 0,
    feedback_incorrect_information TEXT,
    lack_professionalism INTEGER DEFAULT 0,
    feedback_lack_professionalism TEXT,
    escalation_issue INTEGER DEFAULT 0,
    feedback_escalation_issue TEXT,
    lack_investigation INTEGER DEFAULT 0,
    feedback_lack_investigation TEXT,
    lack_empathy INTEGER DEFAULT 0,
    feedback_lack_empathy TEXT,
    lack_knowledge INTEGER DEFAULT 0,
    feedback_lack_knowledge TEXT,
    lack_internal_comms INTEGER DEFAULT 0,
    feedback_lack_internal_comms TEXT,
    missing_information INTEGER DEFAULT 0,
    feedback_missing_information TEXT,
    outdated_macro INTEGER DEFAULT 0,
    feedback_outdated_macro TEXT,
    information_overload INTEGER DEFAULT 0,
    feedback_information_overload TEXT,
    grammatical_errors INTEGER DEFAULT 0,
    feedback_grammatical_errors TEXT,
    engagement_issue INTEGER DEFAULT 0,
    feedback_engagement_issue TEXT,
    missing_minimal_info INTEGER DEFAULT 0,
    feedback_missing_minimal_info TEXT,
    revenue_or_policy_violation INTEGER DEFAULT 0,
    feedback_revenue_or_policy_violation TEXT,
    confidentiality_breach INTEGER DEFAULT 0,
    feedback_confidentiality_breach TEXT,
    unprofessional_conduct INTEGER DEFAULT 0,
    feedback_unprofessional_conduct TEXT,
    complete_resolution_before_closure INTEGER DEFAULT 0,
    feedback_complete_resolution_before_closure TEXT,
    incorrect_or_misleading_information INTEGER DEFAULT 0,
    feedback_incorrect_or_misleading_information TEXT,
    operational_diligence INTEGER DEFAULT 0,
    feedback_operational_diligence TEXT,
    professional_and_empathetic_tone INTEGER DEFAULT 0,
    feedback_professional_and_empathetic_tone TEXT,
    ownership_and_resolution_clarity INTEGER DEFAULT 0,
    feedback_ownership_and_resolution_clarity TEXT,
    clear_and_logical_communication INTEGER DEFAULT 0,
    feedback_clear_and_logical_communication TEXT,
    celebrate_achievements INTEGER DEFAULT 0,
    feedback_celebrate_achievements TEXT,
    brand_tone_and_etiquette INTEGER DEFAULT 0,
    feedback_brand_tone_and_etiquette TEXT,
    review_link_post_positive_interaction INTEGER DEFAULT 0,
    feedback_review_link_post_positive_interaction TEXT,
    grammar INTEGER DEFAULT 0,
    feedback_grammar TEXT,
    PRIMARY KEY (id)
);

-- Add comment
COMMENT ON TABLE ai_analysis_results IS 'Stores AI analysis results for conversations - same schema as fnchat_cfd_v2';


